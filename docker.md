
# Гайд по настройке OpenVPN с использованием Docker Compose

Этот гайд поможет вам настроить OpenVPN-сервер и клиент с использованием Docker Compose. Мы рассмотрим шаги для установки и настройки OpenVPN на сервере и клиенте в контейнерах.

## Шаг 1: Подготовка сервера

### 1.1. Создание директории проекта

На сервере создайте директорию, где будет находиться проект Docker Compose:

```bash
mkdir openvpn-docker
cd openvpn-docker
```

### 1.2. Создание Docker Compose файла

В директории создайте файл `docker-compose.yml`, который будет использоваться для настройки OpenVPN-сервера:

```yaml
version: '3.8'

services:
  openvpn-server:
    image: kylemanna/openvpn
    container_name: openvpn-server
    restart: always
    ports:
      - "1194:1194/udp"  # Проброс порта 1194 для UDP, который использует OpenVPN
    environment:
      - OVPN_NETWORK=10.8.0.0/24  # Сеть OpenVPN, которую будет использовать сервер
      - OVPN_SERVER_URL=udp://<IP_Сервера>:1194  # URL для подключения клиентов, замените <IP_Сервера> на ваш реальный IP
    volumes:
      - ./openvpn-data/conf:/etc/openvpn  # Монтируем конфигурацию OpenVPN
    cap_add:
      - NET_ADMIN  # Необходимы привилегии для работы с сетью
    devices:
      - "/dev/net/tun"  # Для использования туннелей
```

#### Что происходит в файле `docker-compose.yml`:
- **`image: kylemanna/openvpn`**: Используется официальный образ OpenVPN.
- **`ports: "1194:1194/udp"`**: Проброс порта 1194, который используется для VPN-соединений.
- **`volumes: ./openvpn-data/conf:/etc/openvpn`**: Монтируем локальную директорию для хранения конфигурации OpenVPN, чтобы файлы не терялись при перезапуске контейнера.
- **`cap_add: NET_ADMIN`**: Даем контейнеру права для работы с сетью.
- **`devices: "/dev/net/tun"`**: Добавляем устройство для работы с туннелем.

### 1.3. Инициализация конфигурации OpenVPN

Теперь нужно сгенерировать начальные ключи и сертификаты для OpenVPN. Для этого запустите контейнер для инициализации:

```bash
docker-compose run --rm openvpn-server ovpn_genconfig -u udp://<IP_Сервера>:1194
docker-compose run --rm openvpn-server ovpn_initpki
```

**Что происходит в этих командах**:
- **`ovpn_genconfig -u udp://<IP_Сервера>:1194`**: Генерирует конфигурацию OpenVPN для сервера. Замените `<IP_Сервера>` на реальный IP вашего сервера.
- **`ovpn_initpki`**: Инициализирует инфраструктуру открытых ключей (PKI) и генерирует необходимые сертификаты.

### 1.4. Запуск OpenVPN-сервера

Запустите OpenVPN-сервер в фоновом режиме с помощью Docker Compose:

```bash
docker-compose up -d
```

Контейнер будет работать в фоне и слушать подключение на порту 1194.

### 1.5. Генерация клиентского сертификата

Чтобы создать сертификат для клиента (например, для малинки), выполните:

```bash
docker-compose run --rm openvpn-server easyrsa build-client-full raspberry nopass
```

Эта команда генерирует сертификат для клиента `raspberry` без пароля.

---

## Шаг 2: Настройка клиента (например, на малинке)

### 2.1. Создание директории для клиента

На клиенте (например, на малинке) создайте директорию для конфигурации:

```bash
mkdir openvpn-client
cd openvpn-client
```

### 2.2. Создание Docker Compose файла для клиента

В директории клиента создайте файл `docker-compose.yml`:

```yaml
version: '3.8'

services:
  openvpn-client:
    image: openvpn/openvpn
    container_name: openvpn-client
    restart: always
    volumes:
      - ./config:/etc/openvpn  # Монтируем конфигурацию клиента
    cap_add:
      - NET_ADMIN  # Необходимы привилегии для работы с сетью
    devices:
      - "/dev/net/tun"  # Для использования туннелей
    command: "bash -c 'openvpn --config /etc/openvpn/raspberry.ovpn'"  # Запуск OpenVPN с конфигурацией
```

#### Что происходит в файле `docker-compose.yml` для клиента:
- **`volumes: ./config:/etc/openvpn`**: Монтируем директорию с конфигурационными файлами клиента.
- **`command: "bash -c 'openvpn --config /etc/openvpn/raspberry.ovpn'"`**: Указываем команду для запуска OpenVPN с конфигом клиента.

### 2.3. Передача конфигурации

Передайте файл конфигурации `raspberry.ovpn` (который вы создали на сервере) на клиент:

```bash
scp raspberry.ovpn <пользователь>@<IP_Малинки>:/path/to/openvpn-client/config/
```

### 2.4. Запуск клиента

В директории `openvpn-client` запустите контейнер для подключения:

```bash
docker-compose up -d
```

Клиент будет подключаться к серверу и работать как туннель.

---

## Шаг 3: Проверка подключения

### 3.1. На сервере

После запуска серверного контейнера проверьте, что OpenVPN работает:

```bash
docker-compose ps
```

Также проверьте интерфейс `tun0` на сервере:

```bash
ip a
```

### 3.2. На клиенте

На клиенте проверьте работу контейнера:

```bash
docker-compose ps
```

Также проверьте интерфейс `tun0` на клиенте:

```bash
ip a
```

---

## Шаг 4: Доступность конфигурационных файлов

Все конфигурационные файлы будут храниться вне контейнеров, в локальных папках:

1. На сервере:
   - Конфигурация OpenVPN: `./openvpn-data/conf` (монтируется в `/etc/openvpn` внутри контейнера).
   - Генерация ключей и сертификатов: они будут находиться в директории, где вы запускали команду `ovpn_initpki`.

2. На клиенте:
   - Конфигурация клиента: в директории `./config`, где вы будете хранить файлы конфигурации, такие как `raspberry.ovpn`.

---

## Заключение

С помощью Docker Compose вы можете легко развернуть и управлять OpenVPN как на сервере, так и на клиенте. Это удобное решение для создания защищенного VPN-соединения с минимальными усилиями.

---
